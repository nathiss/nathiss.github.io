<!doctype html><html lang=en data-theme=light class=h-full><head><script>{const e=localStorage.theme;if(e!==null)document.documentElement.setAttribute("data-theme",e);else{const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";document.documentElement.setAttribute("data-theme",e)}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CXYG0Q9PH0"></script><script>var dnt,doNotTrack=!1;if(!0&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CXYG0Q9PH0")}</script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet type=text/css href=https://madebyme.today/stylesheets/output.min.ef73616c18e6dbb7d0c4b06eb168690961d9fa5d5bbd25e9648a55378c8cf04c1e9409e82cd71efe6ba538a047420e54e491653eda9a46327b49414db89ddc6f.css integrity="sha512-73NhbBjm27fQxLBusWhpCWHZ+l1bvSXpZIpVN4yM8EwelAnoLNce/mulOKBHQg5U5JFlPtqaRjJ7SUFNuJ3cbw=="><link rel=stylesheet type=text/css href=https://madebyme.today/stylesheets/syntax/light.min.f8c5af1bbcb050c9a0f9bc73e6a627b23a8825d8537cb416518426e6d791257ade4676cd57fcabcbb1542e43618a986520126eae9a236ba2937a49b8db8968f0.css integrity="sha512-+MWvG7ywUMmg+bxz5qYnsjqIJdhTfLQWUYQm5teRJXreRnbNV/yry7FULkNhiphlIBJurpoja6KTekm424lo8A=="><link rel=stylesheet type=text/css href=https://madebyme.today/stylesheets/syntax/dark.min.e82275a221c102f04ff48a5a0444f4753cd8fe31e437176a94bb4d1f80d0fce5027a1414ad6ad9d0b8ab893f421c6cf15be886ffb228b55cd8cd85399d60ef99.css integrity="sha512-6CJ1oiHBAvBP9IpaBET0dTzY/jHkNxdqlLtNH4DQ/OUCehQUrWrZ0LiriT9CHGzxW+iG/7IotVzYzYU5nWDvmQ=="><link rel=icon href=/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://madebyme.today/favicons/favicon-16x16-box-light.png><link rel=icon type=image/png sizes=32x32 href=https://madebyme.today/favicons/favicon-32x32-box-light.png><link rel=icon type=image/png sizes=64x64 href=https://madebyme.today/favicons/favicon-64x64-box-light.png><link rel=apple-touch-icon sizes=180x180 href=https://madebyme.today/favicons/favicon-180x180-box-light.png><link rel=canonical href=https://madebyme.today/projects/cancellable/><link rel=alternate type=application/rss+xml href=https://madebyme.today/index.xml title=MadeByMe><meta name=description content="Recently I&rsquo;m investing a lot of time into developing a game server in Rust. I started with
implementing network layer based on WebSockets. It&rsquo;s far from being ready,
but I developed a helper crate for creating detached, cancellable services."><meta name=author content="Kamil Rusin"><meta name=msapplication-TileColor content="#f5f5f5"><meta name=theme-color content="#f5f5f5"><meta name=twitter:dnt content="on"><meta name=title property="og:title" content="Cancellable"><meta property="og:description" content="
        
            Recently I&rsquo;m investing a lot of time into developing a game server in Rust. I started with
implementing network layer based on WebSockets. It&rsquo;s far from being ready,
but I developed a helper crate for creating detached, cancellable services.
        
    "><meta property="og:type" content="
        article
    "><meta property="og:url" content="https://madebyme.today/projects/cancellable/"><meta name=image property="og:image" content="https://madebyme.today/projects/cancellable/making_progress.png"><meta property="article:section" content="projects"><meta property="article:published_time" content="2023-07-26T09:08:18+02:00"><meta property="article:modified_time" content="2024-01-01T20:25:12+02:00"><meta property="article:author" content="Kamil Rusin"><meta property="og:site_name" content="MadeByMe"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://madebyme.today/projects/cancellable/making_progress.png"><meta name=twitter:title content="Cancellable"><meta name=twitter:description content="Recently I‚Äôm investing a lot of time into developing a game server in Rust. I started with implementing network layer based on WebSockets. It‚Äôs far from being ready, but I developed a helper crate for creating detached, cancellable services."><meta name=twitter:site content="@AreElectrons"><meta name=generator content="Hugo 0.133.0"><title>Cancellable - MadeByMe</title>
<script>const themeToColor={light:"#F5F5F5",dark:"#2A303C"},giscusSendMessage=e=>{const t=document.querySelector("iframe.giscus-frame");if(!t)return;t.contentWindow.postMessage({giscus:e},"https://giscus.app")},getTheme=()=>{const e=localStorage.getItem("theme");return e!==null?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"},setTheme=e=>{localStorage.setItem("theme",e),reloadTheme(e)},reloadTheme=e=>{document.documentElement.setAttribute("data-theme",e),updateThemeCheckboxStatus(),giscusSendMessage({setConfig:{theme:getTheme()}});const t=themeToColor[e];document.querySelector('meta[name="theme-color"]').setAttribute("content",t),document.querySelector('meta[name="msapplication-TileColor"]').setAttribute("content",t)},setUserTheme=e=>{const t=e.checked?"dark":"light";setTheme(t)},updateThemeCheckboxStatus=()=>{const e=document.getElementById("theme-checkbox");e.checked=getTheme()==="dark"};window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{reloadTheme(getTheme())})</script><script>let FF_FOUC_FIX</script></head><body class="h-full flex flex-col"><nav class="navbar justify-between bg-base-100"><div class=navbar-start><div class=dropdown><div tabindex=0 role=button class="btn btn-ghost lg:hidden" aria-label=Menu><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"/></svg></div><ul tabindex=0 class="menu dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"><li><a href=https://madebyme.today/blog/ title=Blog class=nav-link>Blog</a></li><li><a href=https://madebyme.today/projects/ title=Projects class=nav-link>Projects</a></li><li><a href=https://jungle.madebyme.today/ title="Welcome to the üå¥ Jungle!" class=nav-link>üå¥ Jungle</a></li><li><a href=https://madebyme.today/cv/ title=Resum√© class=nav-link>Resum√©</a></li></ul></div><a class="btn btn-ghost text-xl flex flex-col text-primary font-bold" href=https://madebyme.today/>MadeByMe</a></div><div><div class="hidden lg:flex"><ul class="menu menu-horizontal px-1"><li><a href=https://madebyme.today/blog/ title=Blog class=nav-link>Blog</a></li><li><a href=https://madebyme.today/projects/ title=Projects class=nav-link>Projects</a></li><li><a href=https://jungle.madebyme.today/ title="Welcome to the üå¥ Jungle!" class=nav-link>üå¥ Jungle</a></li><li><a href=https://madebyme.today/cv/ title=Resum√© class=nav-link>Resum√©</a></li></ul></div><label class="flex cursor-pointer gap-2" aria-label="Change theme"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2m18 0h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
<input id=theme-checkbox type=checkbox value=dark aria-label="Change theme" onchange=setUserTheme(this) class="toggle theme-controller bg-primary-500 hover:bg-primary-500 dark:bg-darkmode-primary-500 dark:hover:bg-darkmode-primary-500"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></label></div></nav><main class="grow md:container px-6 !max-w-3xl"><nav class="breadcrumbs text-sm"><script type=application/ld+json>{"@context":"https://schema.org/","@type":"BreadcrumbList","itemListOrder":"ItemListOrderAscending","itemListElement":[{"@context":"https://schema.org/","@type":"ListItem","position":1,"name":"MadeByMe","item":"https://madebyme.today/","url":"https://madebyme.today/projects/cancellable/"},{"@context":"https://schema.org/","@type":"ListItem","position":2,"name":"Projects","item":"https://madebyme.today/projects/","url":"https://madebyme.today/projects/cancellable/"},{"@context":"https://schema.org/","@type":"ListItem","position":3,"name":"Cancellable","item":"https://madebyme.today/projects/cancellable/","url":"https://madebyme.today/projects/cancellable/"}]}</script><ul><li><a class=hover:decoration-dashed href=https://madebyme.today/><span>root</span></a></li><li><a class=hover:decoration-dashed href=https://madebyme.today/projects/><span>Projects</span></a></li><li><a class=hover:decoration-dashed href=https://madebyme.today/projects/cancellable/><span>Cancellable</span></a></li></ul></nav><article class=entry><script type=application/ld+json>{"@context":"https://schema.org/","@type":"BlogPosting","name":"Cancellable","headline":"Cancellable | MadeByMe","alternativeHeadline":"Cancellable | MadeByMe","url":"https://madebyme.today/projects/cancellable/","datePublished":"2023-07-26T09:08:18+02:00","inLanguage":"en-us","wordCount":721,"isFamilyFriendly":"true","copyrightYear":"2023","copyrightHolder":{"@context":"https://schema.org/","@type":"Person","givenName":"Kamil","familyName":"Rusin","name":"Kamil Rusin"},"description":"Recently I\u0026rsquo;m investing a lot of time into developing a game server in Rust. I started with implementing network layer based on WebSockets. It\u0026rsquo;s far from being ready, but I developed a helper crate for creating detached, cancellable services.\n","publisher":{"@context":"https://schema.org/","@type":"Organization","name":"MadeByMe","url":"https://madebyme.today/"},"image":["https://madebyme.today/projects/cancellable/making_progress.png"],"thumbnailUrl":"https://madebyme.today/projects/cancellable/making_progress.png","keywords":["Rust","Crates","Open Source"],"mainEntityOfPage":"true","articleBody":"Recently I\u0026rsquo;m investing a lot of time into developing a game server in Rust. I started with implementing network layer based on WebSockets. It\u0026rsquo;s far from being ready, but I developed a helper crate for creating detached, cancellable services.\nGame server backstory The idea of developing an authoritative game server always seemed appealing to me. Network programming, however, has many pitfalls:\nServer need to validate all use inputs to protect game state from bad actors. Ill-formed data sent by one client should not deny service for another player. Async programming is hard in general. So, in the past I have had many attempts to develop a game server. Each improving on mistakes made in the previous one.\nspectrum-old \u0026ndash; A real-time multiplayer browser game, Fusion-cpp \u0026ndash; This is the source code of the server for the Fusion game, [private repo], [private repo], [private repo]. And now I\u0026rsquo;m working on another. :thumbs_up:\nThis time, improvements over the previous one are creating implementation that depend on traits and organizing TODOs to a single GitHub project.\nMaking Progressxkcd #1906\nCancellable crate Network functionalities in game servers (listeners, TCP streams, etc.) await for some input and usually yield a result.\nComponent Input Output Listener new incoming connection Client object TCP Stream data package parsed ClientMessage model Ping service timer tick new ping frame We can define a trait that will describe common interface for all of them:\n1#[async_trait::async_trait] 2pub trait Cancellable { 3 type Result; 4 type Error; 5 6 async fn run(\u0026amp;mut self) -\u0026gt; Result\u0026lt;CancellationResult\u0026lt;Self::Result\u0026gt;, Self::Error\u0026gt;; 7} Method run performs a single unit of work of the service. Internally it can await for the input to be available and then return its result. If the returned value is Err(Self::Error) then the service completes. If it succeeds, then it should return Ok(CancellationResult). CancellationResult is an enum defined as follows:\n1pub enum CancellationResult\u0026lt;T\u0026gt; { 2 Item(T), 3 Continue, 4 Break, 5} 6 7impl\u0026lt;T\u0026gt; CancellationResult\u0026lt;T\u0026gt; { 8 pub fn item(t: impl Into\u0026lt;T\u0026gt;) -\u0026gt; Self { 9 Self::Item(t.into()) 10 } 11} Enum\u0026rsquo;s variant control whether the service will continue to perform its work. If the service produces a value, then it should wrap it as CancellableResult::Item(t); it\u0026rsquo;s also a signal that the service should continue to work. If no value is available, but the service should continue then it returns CancellableResult::Continue (similar to Poll::Pending).\nIf the service finishes its work successfully (e.g. when the peer closes the connection) then the service should return CancellableResult::Break.\nCancellable trait has methods for spawning the service as a detached, background task:\n1#[async_trait::async_trait] 2pub trait Cancellable { 3 // ... 4 5 async fn spawn(mut self, cancellation_token: CancellationToken) -\u0026gt; CancellableHandle\u0026lt;Self\u0026gt; { 6 // ... 7 } 8 9 async fn spawn_with_callback\u0026lt;F\u0026gt;( 10 mut self, 11 cancellation_token: CancellationToken, 12 mut callback: F, 13 ) -\u0026gt; CancellableHandle\u0026lt;Self\u0026gt; 14 where 15 F: FnMut(Self::Result) -\u0026gt; Result\u0026lt;(), Self::Result\u0026gt; 16 { 17 // ... 18 } 19} Both return a handle, which can be awaited for the service to complete, once it has been cancelled!\nIf the service produces results, then it can be spawned with spawn_with_callback, to consume them. If the callback returns Err(Self::Result) then the service completes immediately.\nThis setup offers a way of detaching services which perform work \u0026ldquo;on their own\u0026rdquo;, but sometimes services need to accept additional data. An example is TCP stream: it reads data packages from a peer and consumes them via callback. However, if the server decides the connection should be terminated, then the service should complete its work.\nEnter\u0026hellip;\nCommunicating with detached service When we spawn the service task we already get a handle:\n1let token = CancellableToken::new(); 2 3let handle = service.spawn(token.clone()).await; The handle can be used as an interface to send data to its service.\n1handle.update(ConnectionStatus::TerminatedByServer(reason)); The actual interface needs to be implementation-dependent \u0026ndash; defined in the Cancellable trait. By easily extending the trait we get:\n1#[async_trait::async_trait] 2pub trait Cancellable { 3 // ... 4 type Handle; 5 6 async fn new_handle(\u0026amp;mut self) -\u0026gt; Self::Handle; 7} When the service is spawned (either by spawn or spawn_with_callback), the method will call new_handle to construct the handle. The handle is owned by CancellableHandle, which implements Deref for Self::Handle type. With that setup, we can define a channel by which spawner can communicate with spawnee.\nI like the final product, so I\u0026rsquo;ve packaged it as a crate. It\u0026rsquo;s available on crates.io.\n\u0026#x1f30a;\n","aliases":["https://madebyme.today/articles/cancellable/"],"author":{"@context":"https://schema.org/","@type":"Person","gender":"male","email":"kamil.jakub.rusin@gmail.com","givenName":"Kamil","familyName":"Rusin","name":"Kamil Rusin","jobTitle":"Software Engineer","nationality":{"@context":"https://schema.org/","@type":"Country","name":"PL"},"alumniOf":{"@context":"https://schema.org/","@type":"CollegeOrUniversity","url":"https://www.pk.edu.pl/","name":"The Cracow University of Technology"},"url":"https:\/\/madebyme.today\/"}}</script><script type=application/ld+json>{"@context":"https://schema.org/","@type":"WPHeader","@id":"#article-title","cssSelector":"#article-title"}</script><header class=mt-3><h1 id=article-title class=text-3xl>Cancellable</h1></header><footer class="inline-flex gap-1 flex-wrap"><time datetime=2023-07-26T09:08:18>2023/07/26
</time><span class=select-none>¬∑</span>
<span>4 min</span>
<span class=select-none>¬∑</span>
<a class="btn btn-xs" role=button href=https://madebyme.today/tags/crates/>#Crates</a>
<a class="btn btn-xs" role=button href=https://madebyme.today/tags/open-source/>#Open Source</a>
<a class="btn btn-xs" role=button href=https://madebyme.today/tags/rust/>#Rust</a></footer><details class="collapse bg-base-200 my-3"><summary class="collapse-title text-lg font-medium">Table Of Contents</summary><div class="collapse-content table-of-contents markdown-body"><nav id=TableOfContents><ul><li><a href=#game-server-backstory>Game server backstory</a></li><li><a href=#cancellable-crate>Cancellable crate</a><ul><li><a href=#communicating-with-detached-service>Communicating with detached service</a></li></ul></li></ul></nav></div></details><main class="my-4 markdown-body"><p>Recently I&rsquo;m investing a lot of time into developing a game server in <a href=https://www.rust-lang.org/>Rust</a>. I started with
implementing network layer based on <a href=https://en.wikipedia.org/wiki/WebSocket>WebSockets</a>. It&rsquo;s far from being ready,
but I developed a helper crate for creating detached, cancellable services.</p><h2 id=game-server-backstory class="my-8 md:my-12 flex items-center justify-center"><hr class="w-1/12 border-neutral shrink-0 hidden md:block"><a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral" href=#game-server-backstory aria-label=Anchor>Game server backstory</a><hr class="w-1/12 border-neutral shrink-0 hidden md:block"></h2><p>The idea of developing an authoritative game server always seemed appealing to me. Network programming, however, has
many pitfalls:</p><ul><li>Server need to validate all use inputs to protect game state from bad actors.</li><li>Ill-formed data sent by one client <em>should</em> not deny service for another player.</li><li><a href=https://en.wikipedia.org/wiki/Async/await>Async programming</a> is hard in general.</li></ul><p>So, in the past I have had many attempts to develop a game server. Each improving on mistakes made in the previous one.</p><ul><li><a href=https://github.com/nathiss/spectrum-old>spectrum-old</a> &ndash; A real-time multiplayer browser game,</li><li><a href=https://github.com/nathiss/Fusion-cpp>Fusion-cpp</a> &ndash; This is the source code of the server for the Fusion game,</li><li><em>[private repo]</em>,</li><li><em>[private repo]</em>,</li><li><em>[private repo]</em>.</li></ul><p>And now I&rsquo;m working on another. :thumbs_up:</p><p>This time, improvements over the previous one are creating implementation that depend on traits and organizing TODOs to
a single GitHub project.</p><figure><a href=https://xkcd.com/1906/ class=hide-external target=_blank><img src=https://imgs.xkcd.com/comics/making_progress.png alt="xkcd: Making Progress" loading=lazy></a><figcaption><h4>Making Progress</h4><p>xkcd #1906</p></figcaption></figure><h2 id=cancellable-crate class="my-8 md:my-12 flex items-center justify-center"><hr class="w-1/12 border-neutral shrink-0 hidden md:block"><a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral" href=#cancellable-crate aria-label=Anchor>Cancellable crate</a><hr class="w-1/12 border-neutral shrink-0 hidden md:block"></h2><p>Network functionalities in game servers (listeners, TCP streams, etc.) await for some input and <em>usually</em> yield a
result.</p><div class=table-responsive><table><thead><tr><th>Component</th><th>Input</th><th>Output</th></tr></thead><tbody><tr><td>Listener</td><td>new incoming connection</td><td><code>Client</code> object</td></tr><tr><td>TCP Stream</td><td>data package</td><td>parsed <code>ClientMessage</code> model</td></tr><tr><td>Ping service</td><td>timer tick</td><td>new ping frame</td></tr></tbody></table></div><p>We can define a <code>trait</code> that will describe common interface for all of them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a></span><span class=cl><span class=cp>#[async_trait::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a></span><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>Cancellable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a></span><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nb>Result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a></span><span class=cl><span class=w>    </span><span class=k>type</span> <span class=nc>Error</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a></span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a></span><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>CancellationResult</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=nb>Result</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=bp>Self</span>::<span class=n>Error</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-0-7><a class=lnlinks href=#hl-0-7>7</a></span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Method <code>run</code> performs a single unit of work of the service. Internally it can <code>await</code> for the input to be available and
then return its result. If the returned value is <code>Err(Self::Error)</code> then the service completes. If it succeeds, then it
should return <code>Ok(CancellationResult)</code>. <code>CancellationResult</code> is an enum defined as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a></span><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>CancellationResult</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a></span><span class=cl><span class=w>    </span><span class=n>Item</span><span class=p>(</span><span class=n>T</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a></span><span class=cl><span class=w>    </span><span class=n>Continue</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a></span><span class=cl><span class=w>    </span><span class=n>Break</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a></span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a></span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a></span><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>CancellationResult</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a></span><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>item</span><span class=p>(</span><span class=n>t</span>: <span class=nc>impl</span><span class=w> </span><span class=nb>Into</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a></span><span class=cl><span class=w>        </span><span class=bp>Self</span>::<span class=n>Item</span><span class=p>(</span><span class=n>t</span><span class=p>.</span><span class=n>into</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a></span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a></span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Enum&rsquo;s variant control whether the service will continue to perform its work. If the service produces a value, then it
should wrap it as <code>CancellableResult::Item(t)</code>; it&rsquo;s also a signal that the service should continue to work. If no
value is available, but the service should continue then it returns <code>CancellableResult::Continue</code> (similar to
<a href=https://doc.rust-lang.org/stable/std/task/enum.Poll.html#variant.Pending><code>Poll::Pending</code></a>).</p><p>If the service finishes its work successfully (e.g. when the peer closes the connection) then the service should return
<code>CancellableResult::Break</code>.</p><p><code>Cancellable</code> trait has methods for spawning the service as a detached, background task:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a></span><span class=cl><span class=cp>#[async_trait::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a></span><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>Cancellable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a></span><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=ln id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a></span><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a></span><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>spawn</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>cancellation_token</span>: <span class=nc>CancellationToken</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>CancellableHandle</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a></span><span class=cl><span class=w>        </span><span class=c1>// ...
</span></span></span><span class=line><span class=ln id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a></span><span class=cl><span class=c1></span><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a></span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a></span><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>spawn_with_callback</span><span class=o>&lt;</span><span class=n>F</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a></span><span class=cl><span class=w>            </span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a></span><span class=cl><span class=w>            </span><span class=n>cancellation_token</span>: <span class=nc>CancellationToken</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a></span><span class=cl><span class=w>            </span><span class=k>mut</span><span class=w> </span><span class=n>callback</span>: <span class=nc>F</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a></span><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>CancellableHandle</span><span class=o>&lt;</span><span class=bp>Self</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a></span><span class=cl><span class=w>        </span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a></span><span class=cl><span class=w>            </span><span class=n>F</span>: <span class=nb>FnMut</span><span class=p>(</span><span class=bp>Self</span>::<span class=nb>Result</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=bp>Self</span>::<span class=nb>Result</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a></span><span class=cl><span class=w>        </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a></span><span class=cl><span class=w>            </span><span class=c1>// ...
</span></span></span><span class=line><span class=ln id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a></span><span class=cl><span class=c1></span><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a></span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Both return a handle, which can be awaited for the service to complete, <span class=text-decoration-underline>once it has been
cancelled</span>!</p><p>If the service produces results, then it can be spawned with <code>spawn_with_callback</code>, to consume them. If the callback
returns <code>Err(Self::Result)</code> then the service completes immediately.</p><p>This setup offers a way of detaching services which perform work &ldquo;on their own&rdquo;, but sometimes services <em>need</em> to accept
additional data. An example is TCP stream: it reads data packages from a peer and consumes them via callback. However,
if the server decides the connection should be terminated, then the service should complete its work.</p><p>Enter&mldr;</p><h3 id=communicating-with-detached-service class="my-8 md:my-12 flex items-center justify-center"><hr class="w-1/12 border-neutral shrink-0 hidden md:block"><a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral" href=#communicating-with-detached-service aria-label=Anchor>Communicating with detached service</a><hr class="w-1/12 border-neutral shrink-0 hidden md:block"></h3><p>When we spawn the service task we already get a handle:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a></span><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>token</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CancellableToken</span>::<span class=n>new</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a></span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a></span><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>service</span><span class=p>.</span><span class=n>spawn</span><span class=p>(</span><span class=n>token</span><span class=p>.</span><span class=n>clone</span><span class=p>()).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>The handle can be used as an interface to send data to its service.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-4-1><a class=lnlinks href=#hl-4-1>1</a></span><span class=cl><span class=n>handle</span><span class=p>.</span><span class=n>update</span><span class=p>(</span><span class=n>ConnectionStatus</span>::<span class=n>TerminatedByServer</span><span class=p>(</span><span class=n>reason</span><span class=p>));</span><span class=w>
</span></span></span></code></pre></div><p>The actual interface needs to be implementation-dependent &ndash; defined in the <code>Cancellable</code> trait. By easily extending
the trait we get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=ln id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a></span><span class=cl><span class=cp>#[async_trait::async_trait]</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-5-2><a class=lnlinks href=#hl-5-2>2</a></span><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>trait</span><span class=w> </span><span class=n>Cancellable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-5-3><a class=lnlinks href=#hl-5-3>3</a></span><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=ln id=hl-5-4><a class=lnlinks href=#hl-5-4>4</a></span><span class=cl><span class=c1></span><span class=w>    </span><span class=k>type</span> <span class=nc>Handle</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-5-5><a class=lnlinks href=#hl-5-5>5</a></span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln id=hl-5-6><a class=lnlinks href=#hl-5-6>6</a></span><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>new_handle</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span>::<span class=n>Handle</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=ln id=hl-5-7><a class=lnlinks href=#hl-5-7>7</a></span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>When the service is spawned (either by <code>spawn</code> or <code>spawn_with_callback</code>), the method will call <code>new_handle</code> to construct
the handle. The handle is owned by <code>CancellableHandle</code>, which implements <code>Deref</code> for <code>Self::Handle</code> type. With that
setup, we can define a channel by which spawner can communicate with spawnee.</p><p>I like the final product, so I&rsquo;ve packaged it as a crate. It&rsquo;s available on
<a href=https://crates.io/crates/cancellable>crates.io</a>.</p><p>&#x1f30a;</p></main><div class="w-100 flex justify-center my-8"><hr class="md:w-1/4 w-1/2 border-neutral"></div><div class="alert alert-info text-left text-text flex flex-col items-start gap-0"><h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg"><span class=notification-bell><svg class="size-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848.0 005.454-1.31A8.967 8.967.0 0118 9.75V9A6 6 0 006 9v.75a8.967 8.967.0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714.0a24.255 24.255.0 01-5.714.0m5.714.0a3 3 0 11-5.714.0"/></svg></span>Interested in my work?</h6><div class="collapsible-content w-full"><div class="mt-2 w-full text-base-content"><p class=text-base-content>Consider subscribing to the
<a href=https://madebyme.today/index.xml class="link link-primary" title="RSS Feed">RSS Feed</a> or
joining my mailing list:
<a href=https://groups.google.com/g/madebyme-notifications class="link link-primary">madebyme-notifications on Google Groups </a>.</p><hr class="my-3 border-neutral-content w-full"><p class="text-sm text-neutral-content"><b>Disclaimer:</b> Only group owner (i.e. me) can view e-mail addresses
of group members. I will not share your e-mail with any third-parties
&mdash; it will be used exclusively to notify you about new blog posts.</p></div></div></div><hr class="my-4 border-neutral opacity-25"><script>let theme=getTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"nathiss/nathiss.github.io","data-repo-id":"MDEwOlJlcG9zaXRvcnk4MDYyNjk2Ng==","data-category":"Announcements","data-category-id":"DIC_kwDOBM5FFs4CYJcb","data-mapping":"pathname","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":theme,"data-lang":"en","data-loading":"lazy",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([e,t])=>giscusScript.setAttribute(e,t)),document.querySelector("article.entry").appendChild(giscusScript)</script></article></main><footer class="footer footer-center text-base-content p-4"><aside><p>Copyright &copy;
2023&ndash;2024
<span class=text-primary>Kamil</span>
Rusin
/
<a href=/privacy/ class="link link-primary">Privacy</a></p></aside></footer><div id=madebyme-consent-banner class="toast toast-end hidden w-full sm:w-auto min-w-0 sm:min-w-fit"><div class="card bg-base-100 shadow-xl max-w-lg border"><div class="card-body gap-4"><div class="flex justify-between"><h3 class=card-title>Cookies üç™</h3><button id=close-consent-button class="btn btn-square btn-sm" aria-label=Close><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><div class="markdown-body text-sm"><p>This website uses <a href=https://marketingplatform.google.com/about/analytics/>Google Analytics 4</a> to gather data about page views and <a href=https://giscus.app/>Giscus</a> to support article comments.</p><p>This website respects the <a href=https://en.wikipedia.org/wiki/Do_Not_Track>Do Not Track</a> header field. If you do not wish to be tracked by Google Analytics, then please
enable <a href=https://en.wikipedia.org/wiki/Do_Not_Track>Do Not Track</a> for this domain.</p><p>If you wish to know more about data gathered on this website, read <a href=https://madebyme.today/privacy/>About Tracking & Data Collection</a>.</p></div><button id=consent-button class="btn btn-primary text-wrap">I acknowledge, don't show me this again</button></div></div></div><div id=page-progressbar class="fixed top-0 left-0 w-0 h-1 bg-primary-500 dark:bg-darkmode-primary-500 rounded-e-md" role=progressbar aria-valuemin=0 aria-valuenow=0 aria-valuemax=100></div><script>updateThemeCheckboxStatus(),giscusSendMessage({setConfig:{theme:getTheme()}})</script><script>const consentBannerKey="madebyme-given-consent",consentBannerVersion="9b17d89527a0803c9ca685eace5d3ec887d77f4173ad86d2d064b78ebbeb7497";document.getElementById("close-consent-button").addEventListener("click",()=>{document.getElementById("madebyme-consent-banner").classList.add("hidden")}),document.getElementById("consent-button").addEventListener("click",()=>{localStorage.setItem(consentBannerKey,consentBannerVersion),document.getElementById("madebyme-consent-banner").classList.add("hidden")});const localBannerVersion=localStorage.getItem(consentBannerKey);localBannerVersion!==consentBannerVersion&&document.getElementById("madebyme-consent-banner").classList.remove("hidden")</script><script defer>const readingProgressBar={progressBar:document.getElementById("page-progressbar"),update:()=>{const t=document.documentElement.scrollTop,n=document.documentElement.scrollHeight-document.documentElement.clientHeight,e=t/n*100;readingProgressBar.progressBar.setAttribute("aria-valuenow",Math.trunc(e)),readingProgressBar.progressBar.style.width=e+"%"}};document.addEventListener("scroll",readingProgressBar.update);const bodyResizeObserver=new ResizeObserver(e=>{readingProgressBar.update()});bodyResizeObserver.observe(document.body)</script><script type=application/ld+json>{"@context":"https://schema.org/","@type":"Webpage","mainContentOfPage":{"@context":"https://schema.org/","@type":"WebPageElement","cssSelector":"#site-main"},"primaryImageOfPage":"https://madebyme.today/projects/cancellable/making_progress.png"}</script><script type=application/ld+json>{"@context":"https://schema.org/","@type":"WebSite","name":"MadeByMe","alternateName":"MadeByMe","url":"https://madebyme.today/","description":"I'm Kamil; I work as a software engineer and this is a collection of all things I've been working on in my personal time.","disambiguatingDescription":"I'm Kamil; I work as a software engineer and this is a collection of all things I've been working on in my personal time.","isFamilyFriendly":"true","thumbnailUrl":"https://madebyme.today/favicons/favicon-180x180-box-light.png","image":"https://madebyme.today/favicons/favicon-180x180-box-light.png","inLanguage":"en-us","sameAs":["https://www.madebyme.today","https://www.madebyme.today/","https://madebyme.today","index.xml"],"author":{"@context":"https://schema.org/","@type":"Person","gender":"male","email":"kamil.jakub.rusin@gmail.com","givenName":"Kamil","familyName":"Rusin","name":"Kamil Rusin","jobTitle":"Software Engineer","nationality":{"@context":"https://schema.org/","@type":"Country","name":"PL"},"alumniOf":{"@context":"https://schema.org/","@type":"CollegeOrUniversity","url":"https://www.pk.edu.pl/","name":"The Cracow University of Technology"},"url":"https:\/\/madebyme.today\/"}}</script></body></html>
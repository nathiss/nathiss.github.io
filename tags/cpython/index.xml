<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>CPython on MadeByMe</title><link>https://madebyme.today/tags/cpython/</link><description>Recent content in CPython on MadeByMe</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>Copyright 2023-2025, Kamil Rusin</copyright><lastBuildDate>Mon, 22 Jan 2024 19:34:37 +0100</lastBuildDate><atom:link href="https://madebyme.today/tags/cpython/index.xml" rel="self" type="application/rss+xml"/><item><title>Performance Analysis of Python's `dict()` and `{}`</title><link>https://madebyme.today/blog/python-dict-vs-curly-brackets/</link><pubDate>Mon, 22 Jan 2024 19:34:37 +0100</pubDate><guid>https://madebyme.today/blog/python-dict-vs-curly-brackets/</guid><category>Python</category><category>CPython</category><category>dictionaries</category><description>&lt;p>Some time ago, during a code review, I had a discussion with a colleague of mine about preferring &lt;code>dict()&lt;/code> over &lt;code>{}&lt;/code> in
new Python code. They argued that &lt;code>dict()&lt;/code> is more readable &amp;mdash; and expresses intent more clearly &amp;mdash; therefore should
be preferred. I wasn&amp;rsquo;t convinced by that, but at that time I didn&amp;rsquo;t have any counterarguments, so I passed.&lt;/p>
&lt;p>Yet that made me wonder: what&amp;rsquo;s the difference between the &lt;code>dict&lt;/code> type and &lt;code>{}&lt;/code> literal expression?&lt;/p>
&lt;p>Let&amp;rsquo;s go down the rabbit hole.&lt;/p>
&lt;div class="alert alert-info text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
&lt;/svg>&lt;/span>Note&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">I&amp;rsquo;ll be using &lt;a href="https://www.python.org/downloads/release/python-3120/">Python 3.12&lt;/a> for all code samples here. This is &lt;strong>really important&lt;/strong>, as there are
&lt;a href="https://docs.python.org/3.12/whatsnew/changelog.html">significant differences&lt;/a> between recent minor Python versions.&lt;/div>
&lt;/div>
&lt;/div>
&lt;h2 id="pythons-dictionaries" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#pythons-dictionaries" aria-label="Anchor">Python&amp;rsquo;s dictionaries&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h2>
&lt;p>First, let&amp;rsquo;s check what&amp;rsquo;s the performance difference between the two methods. I&amp;rsquo;ll use the &lt;a href="https://docs.python.org/3.12/library/timeit.html">&lt;code>timeit&lt;/code>&lt;/a>
module for that.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="ln" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;dict()&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">10000000&lt;/span> loops, best of 5: &lt;span class="m">40&lt;/span> nsec per loop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;{}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">20000000&lt;/span> loops, best of 5: 19.6 nsec per loop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>On my MacBook M1 the difference is &lt;strong>almost 2x&lt;/strong>. A non-trivial difference, especially knowing that both of these
expressions produce the exact same object.&lt;/p>
&lt;p>Where does the difference come from?&lt;/p>
&lt;p>Before we get into that, we need to sidetrack a little bit and talk about what happens when you execute Python code.
Python is an &lt;a href="https://en.wikipedia.org/wiki/Scripting_language">interpreted language&lt;/a> &amp;mdash; it needs to have an interpreter. &lt;a href="https://github.com/python/cpython/tree/v3.12.0">CPython&lt;/a> is
the most wildly used interpreter of Python; it&amp;rsquo;s a reference implementation, meaning that other interpreters use it to
determine the &amp;ldquo;correct&amp;rdquo; behavior. If you&amp;rsquo;ve installed Python from a default distribution, you have CPython installed on
your machine.&lt;/p>
&lt;p>Interestingly, CPython is both a compiler and an interpreter. When executing Python code it first compiles it into
&lt;a href="https://docs.python.org/3.12/library/dis.html#python-bytecode-instructions">bytecode&lt;/a> instructions and interprets them.&lt;/p>
&lt;p>To better understand the performance difference between &lt;code>dist()&lt;/code> and &lt;code>{}&lt;/code> let&amp;rsquo;s compare the bytecode instructions they
compile into. Python has a built-in module called &lt;a href="https://docs.python.org/3.12/library/dis.html">dis&lt;/a> which does exactly that.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="nn">dis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">a&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">b&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">1&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="n">RESUME&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">2&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">LOAD_GLOBAL&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">NULL&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">12&lt;/span> &lt;span class="n">CALL&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-13">&lt;a class="lnlinks" href="#hl-1-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">20&lt;/span> &lt;span class="n">RETURN_VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-14">&lt;a class="lnlinks" href="#hl-1-14">14&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-15">&lt;a class="lnlinks" href="#hl-1-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">1&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="n">RESUME&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-16">&lt;a class="lnlinks" href="#hl-1-16">16&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-17">&lt;a class="lnlinks" href="#hl-1-17">17&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">2&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">BUILD_MAP&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-18">&lt;a class="lnlinks" href="#hl-1-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">4&lt;/span> &lt;span class="n">RETURN_VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Although they produce the same end result these two expression, quite clearly, execute different code.&lt;/p>
&lt;h3 id="bytecode-instructions" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#bytecode-instructions" aria-label="Anchor">Bytecode instructions&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h3>
&lt;p>The output of &lt;code>dis.dis&lt;/code> isn&amp;rsquo;t very hard to understand.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln" id="hl-2-1">&lt;a class="lnlinks" href="#hl-2-1">1&lt;/a>&lt;/span>&lt;span class="cl"> (1) | (2) | (3) | (4) | (5)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-2">&lt;a class="lnlinks" href="#hl-2-2">2&lt;/a>&lt;/span>&lt;span class="cl">-----|-----------|-----------------------|-----|---------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-3">&lt;a class="lnlinks" href="#hl-2-3">3&lt;/a>&lt;/span>&lt;span class="cl"> 1 | 0 | RESUME | 0 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-4">&lt;a class="lnlinks" href="#hl-2-4">4&lt;/a>&lt;/span>&lt;span class="cl"> | | | |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-5">&lt;a class="lnlinks" href="#hl-2-5">5&lt;/a>&lt;/span>&lt;span class="cl"> 2 | 2 | LOAD_GLOBAL | 1 | (NULL + dict)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-6">&lt;a class="lnlinks" href="#hl-2-6">6&lt;/a>&lt;/span>&lt;span class="cl"> | 12 | CALL | 0 |
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-2-7">&lt;a class="lnlinks" href="#hl-2-7">7&lt;/a>&lt;/span>&lt;span class="cl"> | 20 | RETURN_VALUE | |
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Each column has a purpose:&lt;/p>
&lt;ol>
&lt;li>Line number in the source code.&lt;/li>
&lt;li>The address of the instruction &amp;mdash; byte index in the compiled bytecode.&lt;/li>
&lt;li>The bytecode name (opcode).&lt;/li>
&lt;li>Operation parameters.&lt;/li>
&lt;li>Human-readable interpretation of the operation parameters.&lt;/li>
&lt;/ol>
&lt;p>Alright, equipped with this knowledge and by cross-referencing the &lt;a href="https://docs.python.org/3.12/library/dis.html#python-bytecode-instructions">opcode set&lt;/a> we know that:&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://docs.python.org/3.12/library/dis.html#opcode-RESUME">&lt;code>RESUME&lt;/code>&lt;/a> &amp;mdash; does nothing. It performs internal tracking, debugging and optimization checks.&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/3.12/library/dis.html#opcode-LOAD_GLOBAL">&lt;code>LOAD_GLOBAL&lt;/code>&lt;/a> &amp;mdash; loads a global variable onto the stack. From the human-readable interpretation of the opcode
parameters we know that it loads &lt;code>dict&lt;/code> (ignore &lt;code>NULL&lt;/code> for now).&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/3.12/library/dis.html#opcode-CALL">&lt;code>CALL&lt;/code>&lt;/a> &amp;mdash; calls a callable object with the number of arguments specified by &lt;code>argc&lt;/code> &amp;mdash; in our case it&amp;rsquo;s zero.&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/3.12/library/dis.html#opcode-RETURN_VALUE">&lt;code>RETURN_VALUE&lt;/code>&lt;/a> &amp;mdash; returns with the last element from the stack to the caller.&lt;/li>
&lt;/ol>
&lt;p>Compiling &lt;code>return {}&lt;/code> yields one more opcode:&lt;/p>
&lt;!-- markdownlint-disable ol-prefix -->
&lt;ol start="5">
&lt;li>&lt;a href="https://docs.python.org/3.12/library/dis.html#opcode-BUILD_MAP">&lt;code>BUILD_MAP&lt;/code>&lt;/a> &amp;mdash; pushes a new dictionary object onto the stack. Pops &lt;code>2 * count&lt;/code> items so that the dictionary holds
count entries.&lt;/li>
&lt;/ol>
&lt;!-- markdownlint-enable ol-prefix -->
&lt;p>Already we have a few obvious differences between the two cases. The &lt;code>{}&lt;/code> expression builds a dictionary directly, while
&lt;code>dict()&lt;/code> delegates that to a callable object. Before that can even happen it first needs to load the global value
(&lt;code>dict&lt;/code>) onto the stack &amp;mdash; it actually does that every single time we call that function.&lt;/p>
&lt;p>Why?&lt;/p>
&lt;p>Because &lt;code>dict&lt;/code> is not constant: it can be overwritten &amp;mdash; and therefore &amp;mdash; produce a different value.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-3-1">&lt;a class="lnlinks" href="#hl-3-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">a&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-3-2">&lt;a class="lnlinks" href="#hl-3-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">dict&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-3-3">&lt;a class="lnlinks" href="#hl-3-3">3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-3-4">&lt;a class="lnlinks" href="#hl-3-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">dict&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">lambda&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-3-5">&lt;a class="lnlinks" href="#hl-3-5">5&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-3-6">&lt;a class="lnlinks" href="#hl-3-6">6&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">assert&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It can happen. This is why Python needs to generate this overhead of loading and calling a callable for every call of
the function.&lt;/p>
&lt;p>OK, it all sounds very neat. Calling a callable does create an overhead and it&amp;rsquo;s reasonable to assume that the
difference we saw at the beginning of this post is a result of this overhead. However, are we sure that &lt;code>dict()&lt;/code>
internally calls the same code, as &lt;code>{}&lt;/code> does? &lt;code>dict&lt;/code> is a class and, luckily, the &lt;a href="https://docs.python.org/3/library/dis.html#dis.dis">&lt;code>dis.dis&lt;/code>&lt;/a> function can compile
classes to bytecode.&lt;/p>
&lt;div class="alert alert-info text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
&lt;/svg>&lt;/span>Example&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">dis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Foo&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">bar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-5">&lt;a class="lnlinks" href="#hl-0-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-6">&lt;a class="lnlinks" href="#hl-0-6"> 6&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-7">&lt;a class="lnlinks" href="#hl-0-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__str__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-8">&lt;a class="lnlinks" href="#hl-0-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__class__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__name__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-9">&lt;a class="lnlinks" href="#hl-0-9"> 9&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-10">&lt;a class="lnlinks" href="#hl-0-10">10&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Foo&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It prints out disassembly for all of the classes&amp;rsquo;s methods:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln" id="hl-1-1">&lt;a class="lnlinks" href="#hl-1-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">Disassembly of __str__:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-2">&lt;a class="lnlinks" href="#hl-1-2"> 2&lt;/a>&lt;/span>&lt;span class="cl"> 8 0 RESUME 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-3">&lt;a class="lnlinks" href="#hl-1-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-4">&lt;a class="lnlinks" href="#hl-1-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> 9 2 LOAD_FAST 0 (self)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-5">&lt;a class="lnlinks" href="#hl-1-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> 4 LOAD_ATTR 0 (__class__)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-6">&lt;a class="lnlinks" href="#hl-1-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> 24 LOAD_ATTR 2 (__name__)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-7">&lt;a class="lnlinks" href="#hl-1-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> 44 RETURN_VALUE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-8">&lt;a class="lnlinks" href="#hl-1-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-9">&lt;a class="lnlinks" href="#hl-1-9"> 9&lt;/a>&lt;/span>&lt;span class="cl">Disassembly of bar:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-10">&lt;a class="lnlinks" href="#hl-1-10">10&lt;/a>&lt;/span>&lt;span class="cl"> 5 0 RESUME 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-11">&lt;a class="lnlinks" href="#hl-1-11">11&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-1-12">&lt;a class="lnlinks" href="#hl-1-12">12&lt;/a>&lt;/span>&lt;span class="cl"> 6 2 RETURN_CONST 1 (42)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>Let&amp;rsquo;s try this for &lt;code>dict&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-4-1">&lt;a class="lnlinks" href="#hl-4-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">dict&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-4-2">&lt;a class="lnlinks" href="#hl-4-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip; it doesn&amp;rsquo;t print anything? Why?&lt;/p>
&lt;p>Well, the &lt;a href="https://docs.python.org/3.12/library/dis.html">dis&lt;/a> module isn&amp;rsquo;t very useful for internal types and &lt;code>dict&lt;/code> is one of those types &amp;mdash; defined
within the interpreter&amp;rsquo;s source code.&lt;/p>
&lt;h3 id="getting-lost-in-the-cpython-source-code" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#getting-lost-in-the-cpython-source-code" aria-label="Anchor">Getting lost in the CPython source code&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h3>
&lt;p>To tap into the forbidden magic, we need to clone the &lt;a href="https://github.com/python/cpython/tree/main">CPython repository&lt;/a> first. We don&amp;rsquo;t need all the
history, so let&amp;rsquo;s &lt;a href="https://git-scm.com/docs/git-clone#Documentation/git-clone.txt---depthltdepthgt">&lt;code>--depth 1&lt;/code>&lt;/a> this.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="ln" id="hl-5-1">&lt;a class="lnlinks" href="#hl-5-1">1&lt;/a>&lt;/span>&lt;span class="cl">git clone --depth &lt;span class="m">1&lt;/span> --branch v3.12.0 https://github.com/python/cpython.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-5-2">&lt;a class="lnlinks" href="#hl-5-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1"># or&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-5-3">&lt;a class="lnlinks" href="#hl-5-3">3&lt;/a>&lt;/span>&lt;span class="cl">git clone --depth &lt;span class="m">1&lt;/span> --branch v3.12.0 git@github.com:python/cpython.git
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then we need to find what we&amp;rsquo;re actually looking for &amp;mdash; a place where opcode instructions are interpreted. After a cup
of coffee and a lot of greps later we find the &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c">&lt;code>Python/bytecodes.c&lt;/code>&lt;/a> file. It consists of a single &lt;code>switch&lt;/code>
statement and it seems like all bytecode instruction are interpreted there.&lt;/p>
&lt;h4 id="the-dict-type" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#the-dict-type" aria-label="Anchor">The &lt;code>dict&lt;/code> type&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>Let&amp;rsquo;s tackle &lt;code>dict&lt;/code> first. All internal types are defined as &lt;code>PyTypeObject&lt;/code> objects and the &lt;code>dict&lt;/code> type is defined in
the &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L3839">&lt;code>dictobject.c&lt;/code>&lt;/a> file. It has a lot of attributes defined, but only two are of interest
for us:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-6-1">&lt;a class="lnlinks" href="#hl-6-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyTypeObject&lt;/span> &lt;span class="n">PyDict_Type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-2">&lt;a class="lnlinks" href="#hl-6-2"> 2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">PyVarObject_HEAD_INIT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">PyType_Type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-3">&lt;a class="lnlinks" href="#hl-6-3"> 3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;dict&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-4">&lt;a class="lnlinks" href="#hl-6-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyDictObject&lt;/span>&lt;span class="p">),&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-5">&lt;a class="lnlinks" href="#hl-6-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-6">&lt;a class="lnlinks" href="#hl-6-6"> 6&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">dict_init&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_init */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-7">&lt;a class="lnlinks" href="#hl-6-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-8">&lt;a class="lnlinks" href="#hl-6-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">dict_new&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_new */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-9">&lt;a class="lnlinks" href="#hl-6-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-6-10">&lt;a class="lnlinks" href="#hl-6-10">10&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The pair (&lt;code>dict_new&lt;/code> and &lt;code>dict_init&lt;/code>) will tell us what happens when someone creates a new dictionary.&lt;/p>
&lt;div class="alert alert-info text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
&lt;/svg>&lt;/span>Note&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">&lt;p>The constructor in Python is called &lt;code>__new__&lt;/code>. It&amp;rsquo;s a static method that returns a new object of its type.&lt;/p>
&lt;p>The initializer method is called &lt;code>__init__&lt;/code>. It takes a newly created object and initializes its attributes. The
&lt;code>__init__&lt;/code>method is called after the &lt;code>__new__&lt;/code> method.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>The &lt;code>dict_new&lt;/code> function is defined here: &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L3751">dictobject.c#L3751&lt;/a>.&lt;/p>
&lt;!-- markdownlint-disable fenced-code-language -->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-7-1">&lt;a class="lnlinks" href="#hl-7-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-2">&lt;a class="lnlinks" href="#hl-7-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">dict_new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyTypeObject&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">kwds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-3">&lt;a class="lnlinks" href="#hl-7-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-4">&lt;a class="lnlinks" href="#hl-7-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-5">&lt;a class="lnlinks" href="#hl-7-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tp_alloc&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-6">&lt;a class="lnlinks" href="#hl-7-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// dict subclasses must implement the GC protocol
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-7">&lt;a class="lnlinks" href="#hl-7-7"> 7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nf">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">_PyType_IS_GC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-8">&lt;a class="lnlinks" href="#hl-7-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-9">&lt;a class="lnlinks" href="#hl-7-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">self&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">type&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="nf">tp_alloc&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-10">&lt;a class="lnlinks" href="#hl-7-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-11">&lt;a class="lnlinks" href="#hl-7-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-12">&lt;a class="lnlinks" href="#hl-7-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-13">&lt;a class="lnlinks" href="#hl-7-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyDictObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PyDictObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-14">&lt;a class="lnlinks" href="#hl-7-14">14&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-7-15">&lt;a class="lnlinks" href="#hl-7-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">d&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ma_used&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-16">&lt;a class="lnlinks" href="#hl-7-16">16&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">d&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ma_version_tag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">DICT_NEXT_VERSION&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-17">&lt;a class="lnlinks" href="#hl-7-17">17&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">_PyInterpreterState_GET&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-18">&lt;a class="lnlinks" href="#hl-7-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">dictkeys_incref&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Py_EMPTY_KEYS&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-7-19">&lt;a class="lnlinks" href="#hl-7-19">19&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">d&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ma_keys&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Py_EMPTY_KEYS&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-7-20">&lt;a class="lnlinks" href="#hl-7-20">20&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">d&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ma_values&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-21">&lt;a class="lnlinks" href="#hl-7-21">21&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">ASSERT_CONSISTENT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">d&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-22">&lt;a class="lnlinks" href="#hl-7-22">22&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-23">&lt;a class="lnlinks" href="#hl-7-23">23&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-24">&lt;a class="lnlinks" href="#hl-7-24">24&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-25">&lt;a class="lnlinks" href="#hl-7-25">25&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">self&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-7-26">&lt;a class="lnlinks" href="#hl-7-26">26&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;!-- markdownlint-enable fenced-code-language -->
&lt;p>We see that first, it allocates a new object via the provided allocator (9&lt;sup>th&lt;/sup> line) and then sets
some of its internal fields (15&lt;sup>th&lt;/sup>, 19&lt;sup>th&lt;/sup>, and 20&lt;sup>th&lt;/sup>).
Interestingly for us, it &lt;strong>does not&lt;/strong> pre-allocate the dictionary&amp;rsquo;s internal memory (see marked lines). It might seems
strange at first, but please remember: an object&amp;rsquo;s initialization &amp;mdash; like memory pre-allocation &amp;mdash; is not a
responsibility of the &lt;code>__new__&lt;/code> method, that what the &lt;code>__init__&lt;/code> method is for.&lt;/p>
&lt;p>With the new object in memory, the &lt;code>dict_init&lt;/code> function can insert entries to it. The insertion logic is delegated to
the &lt;code>dict_update_common&lt;/code> function, which can be found here: &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2678">dictobject.c#L2678&lt;/a>.&lt;/p>
&lt;!-- markdownlint-disable fenced-code-language -->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-8-1">&lt;a class="lnlinks" href="#hl-8-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-2">&lt;a class="lnlinks" href="#hl-8-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">dict_update_common&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">kwds&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-3">&lt;a class="lnlinks" href="#hl-8-3"> 3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">methname&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-4">&lt;a class="lnlinks" href="#hl-8-4"> 4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-5">&lt;a class="lnlinks" href="#hl-8-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-6">&lt;a class="lnlinks" href="#hl-8-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-7">&lt;a class="lnlinks" href="#hl-8-7"> 7&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-8">&lt;a class="lnlinks" href="#hl-8-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nf">PyArg_UnpackTuple&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">methname&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-9">&lt;a class="lnlinks" href="#hl-8-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-10">&lt;a class="lnlinks" href="#hl-8-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-11">&lt;a class="lnlinks" href="#hl-8-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-8-12">&lt;a class="lnlinks" href="#hl-8-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">dict_update_arg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">arg&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-13">&lt;a class="lnlinks" href="#hl-8-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-14">&lt;a class="lnlinks" href="#hl-8-14">14&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-15">&lt;a class="lnlinks" href="#hl-8-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">kwds&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-16">&lt;a class="lnlinks" href="#hl-8-16">16&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">PyArg_ValidateKeywordArguments&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">kwds&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-8-17">&lt;a class="lnlinks" href="#hl-8-17">17&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">PyDict_Merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">kwds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-18">&lt;a class="lnlinks" href="#hl-8-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-19">&lt;a class="lnlinks" href="#hl-8-19">19&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-20">&lt;a class="lnlinks" href="#hl-8-20">20&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-21">&lt;a class="lnlinks" href="#hl-8-21">21&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-8-22">&lt;a class="lnlinks" href="#hl-8-22">22&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;!-- markdownlint-enable fenced-code-language -->
&lt;p>It updates the dictionary from both args and kwargs.&lt;/p>
&lt;h5 id="args--dict_update_arg" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#args--dict_update_arg" aria-label="Anchor">args &amp;amp; &lt;code>dict_update_arg&lt;/code>&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h5>
&lt;p>For &lt;code>args&lt;/code> it calls the &lt;code>dict_update_arg&lt;/code> function.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-9-1">&lt;a class="lnlinks" href="#hl-9-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-2">&lt;a class="lnlinks" href="#hl-9-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">dict_update_arg&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-3">&lt;a class="lnlinks" href="#hl-9-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-4">&lt;a class="lnlinks" href="#hl-9-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">PyDict_CheckExact&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-5">&lt;a class="lnlinks" href="#hl-9-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">PyDict_Merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-6">&lt;a class="lnlinks" href="#hl-9-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-7">&lt;a class="lnlinks" href="#hl-9-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-8">&lt;a class="lnlinks" href="#hl-9-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">_PyObject_LookupAttr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nf">_Py_ID&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-9">&lt;a class="lnlinks" href="#hl-9-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-10">&lt;a class="lnlinks" href="#hl-9-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-11">&lt;a class="lnlinks" href="#hl-9-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-12">&lt;a class="lnlinks" href="#hl-9-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">Py_DECREF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">func&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-13">&lt;a class="lnlinks" href="#hl-9-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">PyDict_Merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-14">&lt;a class="lnlinks" href="#hl-9-14">14&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-15">&lt;a class="lnlinks" href="#hl-9-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nf">PyDict_MergeFromSeq2&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">arg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-9-16">&lt;a class="lnlinks" href="#hl-9-16">16&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The function checks if &lt;code>arg&lt;/code> is a dictionary, if so it merges the two (&lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988">&lt;code>PyDict_Merge&lt;/code>&lt;/a>), otherwise it adds new entries
from a sequence of pairs (&lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2722">&lt;code>PyDict_MergeFromSeq2&lt;/code>&lt;/a>).&lt;/p>
&lt;h5 id="kwargs--pydict_merge" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#kwargs--pydict_merge" aria-label="Anchor">kwargs &amp;amp; &lt;code>PyDict_Merge&lt;/code>&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h5>
&lt;p>The &lt;code>kwargs&lt;/code> path ends in the same place &amp;mdash; &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988">&lt;code>PyDict_Merge&lt;/code>&lt;/a>. Let&amp;rsquo;s take a look.&lt;/p>
&lt;p>Internally, it delegates all logic to the &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2807">&lt;code>dict_merge&lt;/code>&lt;/a> function.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-10-1">&lt;a class="lnlinks" href="#hl-10-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-2">&lt;a class="lnlinks" href="#hl-10-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">dict_merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyInterpreterState&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">interp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">override&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-3">&lt;a class="lnlinks" href="#hl-10-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-4">&lt;a class="lnlinks" href="#hl-10-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyDictObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">mp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">other&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-5">&lt;a class="lnlinks" href="#hl-10-5"> 5&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-6">&lt;a class="lnlinks" href="#hl-10-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="n">override&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">override&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-7">&lt;a class="lnlinks" href="#hl-10-7"> 7&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-8">&lt;a class="lnlinks" href="#hl-10-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* We accept for the argument either a concrete dictionary object,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-9">&lt;a class="lnlinks" href="#hl-10-9"> 9&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="cm"> * or an abstract &amp;#34;mapping&amp;#34; object. For the former, we can do
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-10">&lt;a class="lnlinks" href="#hl-10-10">10&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="cm"> * things quite efficiently. For the latter, we only require that
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-11">&lt;a class="lnlinks" href="#hl-10-11">11&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="cm"> * PyMapping_Keys() and PyObject_GetItem() be supported.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-12">&lt;a class="lnlinks" href="#hl-10-12">12&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-13">&lt;a class="lnlinks" href="#hl-10-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="nf">PyDict_Check&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">b&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-14">&lt;a class="lnlinks" href="#hl-10-14">14&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">PyErr_BadInternalCall&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-15">&lt;a class="lnlinks" href="#hl-10-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-16">&lt;a class="lnlinks" href="#hl-10-16">16&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-17">&lt;a class="lnlinks" href="#hl-10-17">17&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">mp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">PyDictObject&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-18">&lt;a class="lnlinks" href="#hl-10-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">PyDict_Check&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">Py_TYPE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tp_iter&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">getiterfunc&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">dict_iter&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-19">&lt;a class="lnlinks" href="#hl-10-19">19&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-20">&lt;a class="lnlinks" href="#hl-10-20">20&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-21">&lt;a class="lnlinks" href="#hl-10-21">21&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-22">&lt;a class="lnlinks" href="#hl-10-22">22&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* Do it the generic, slower way */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-23">&lt;a class="lnlinks" href="#hl-10-23">23&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-24">&lt;a class="lnlinks" href="#hl-10-24">24&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-25">&lt;a class="lnlinks" href="#hl-10-25">25&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-26">&lt;a class="lnlinks" href="#hl-10-26">26&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">ASSERT_CONSISTENT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-27">&lt;a class="lnlinks" href="#hl-10-27">27&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-10-28">&lt;a class="lnlinks" href="#hl-10-28">28&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>From the comment, we know that the function has been optimized for being called with another dictionary as a parameter.
If the parameter is not a dictionary, then it&amp;rsquo;s a generic &lt;a href="https://docs.python.org/3.12/library/collections.abc.html#collections.abc.Mapping">&lt;code>Mapping&lt;/code>&lt;/a> &amp;mdash; a container object that supports arbitrary key
lookups.&lt;/p>
&lt;h4 id="the--expression" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#the--expression" aria-label="Anchor">The &lt;code>{}&lt;/code> expression&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>The literal expression should be easier to reason about. Let&amp;rsquo;s go back to the &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c">bytecode.c&lt;/a> file and find mapping for the
&lt;code>BUILD_MAP&lt;/code> opcode.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-11-1">&lt;a class="lnlinks" href="#hl-11-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">inst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BUILD_MAP&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">oparg&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">map&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-2">&lt;a class="lnlinks" href="#hl-11-2"> 2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">map&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">_PyDict_FromItems&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-3">&lt;a class="lnlinks" href="#hl-11-3"> 3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">values&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-4">&lt;a class="lnlinks" href="#hl-11-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">values&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-5">&lt;a class="lnlinks" href="#hl-11-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">oparg&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-6">&lt;a class="lnlinks" href="#hl-11-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-7">&lt;a class="lnlinks" href="#hl-11-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">error&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-8">&lt;a class="lnlinks" href="#hl-11-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-9">&lt;a class="lnlinks" href="#hl-11-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">DECREF_INPUTS&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-10">&lt;a class="lnlinks" href="#hl-11-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">ERROR_IF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">map&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">error&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-11-11">&lt;a class="lnlinks" href="#hl-11-11">11&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;em>See sources here: &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Python/bytecodes.c#L1541">bytecode.c#L1541&lt;/a>.&lt;/em>&lt;/p>
&lt;p>We see that the dictionary is fully constructed and returned by &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L1616">&lt;code>_PyDict_FromItems&lt;/code>&lt;/a>. Let&amp;rsquo;s go there.&lt;/p>
&lt;!-- markdownlint-disable fenced-code-language -->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-12-1">&lt;a class="lnlinks" href="#hl-12-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-2">&lt;a class="lnlinks" href="#hl-12-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">_PyDict_FromItems&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Py_ssize_t&lt;/span> &lt;span class="n">keys_offset&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-3">&lt;a class="lnlinks" href="#hl-12-3"> 3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Py_ssize_t&lt;/span> &lt;span class="n">values_offset&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-4">&lt;a class="lnlinks" href="#hl-12-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">Py_ssize_t&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-5">&lt;a class="lnlinks" href="#hl-12-5"> 5&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-6">&lt;a class="lnlinks" href="#hl-12-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="kt">bool&lt;/span> &lt;span class="n">unicode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-7">&lt;a class="lnlinks" href="#hl-12-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">keys&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-8">&lt;a class="lnlinks" href="#hl-12-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyInterpreterState&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">interp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">_PyInterpreterState_GET&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-9">&lt;a class="lnlinks" href="#hl-12-9"> 9&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-10">&lt;a class="lnlinks" href="#hl-12-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Py_ssize_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-11">&lt;a class="lnlinks" href="#hl-12-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="nf">PyUnicode_CheckExact&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">ks&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-12">&lt;a class="lnlinks" href="#hl-12-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">unicode&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-13">&lt;a class="lnlinks" href="#hl-12-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-14">&lt;a class="lnlinks" href="#hl-12-14">14&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-15">&lt;a class="lnlinks" href="#hl-12-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">ks&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">keys_offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-16">&lt;a class="lnlinks" href="#hl-12-16">16&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-17">&lt;a class="lnlinks" href="#hl-12-17">17&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line hl">&lt;span class="ln" id="hl-12-18">&lt;a class="lnlinks" href="#hl-12-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dict&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">dict_new_presized&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">interp&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">unicode&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-19">&lt;a class="lnlinks" href="#hl-12-19">19&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">dict&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-20">&lt;a class="lnlinks" href="#hl-12-20">20&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-21">&lt;a class="lnlinks" href="#hl-12-21">21&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-22">&lt;a class="lnlinks" href="#hl-12-22">22&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-23">&lt;a class="lnlinks" href="#hl-12-23">23&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">ks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">keys&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-24">&lt;a class="lnlinks" href="#hl-12-24">24&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="k">const&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">vs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">values&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-25">&lt;a class="lnlinks" href="#hl-12-25">25&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-26">&lt;a class="lnlinks" href="#hl-12-26">26&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">Py_ssize_t&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">length&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-27">&lt;a class="lnlinks" href="#hl-12-27">27&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">key&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ks&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-28">&lt;a class="lnlinks" href="#hl-12-28">28&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">vs&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-29">&lt;a class="lnlinks" href="#hl-12-29">29&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nf">PyDict_SetItem&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-30">&lt;a class="lnlinks" href="#hl-12-30">30&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">Py_DECREF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dict&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-31">&lt;a class="lnlinks" href="#hl-12-31">31&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-32">&lt;a class="lnlinks" href="#hl-12-32">32&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-33">&lt;a class="lnlinks" href="#hl-12-33">33&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">ks&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">keys_offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-34">&lt;a class="lnlinks" href="#hl-12-34">34&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">vs&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">values_offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-35">&lt;a class="lnlinks" href="#hl-12-35">35&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-36">&lt;a class="lnlinks" href="#hl-12-36">36&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-37">&lt;a class="lnlinks" href="#hl-12-37">37&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">dict&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-12-38">&lt;a class="lnlinks" href="#hl-12-38">38&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;!-- markdownlint-enable fenced-code-language -->
&lt;p>I&amp;rsquo;ve marked the most interesting line: in opposition to &lt;code>dict_new&lt;/code>, it &lt;strong>pre-allocates&lt;/strong> the dictionary, so it already
has a capacity for all of its entries. After that it inserts key-value pairs one-by-one.&lt;/p>
&lt;h2 id="conclusions" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#conclusions" aria-label="Anchor">Conclusions&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h2>
&lt;p>To sum things up.&lt;/p>
&lt;p>When you do &lt;code>dict(a=1, b=2)&lt;/code>, Python needs to:&lt;/p>
&lt;ul>
&lt;li>allocate a new &lt;code>PyObject&lt;/code>,&lt;/li>
&lt;li>construct a &lt;code>dict&lt;/code> via the &lt;code>__new__&lt;/code> method,&lt;/li>
&lt;li>call its &lt;code>__init__&lt;/code> method, which internally calls &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988">&lt;code>PyDict_Merge&lt;/code>&lt;/a>,&lt;/li>
&lt;li>because &lt;code>kwargs&lt;/code> is not &lt;code>dict&lt;/code>, &lt;a href="https://github.com/python/cpython/blob/v3.12.0/Objects/dictobject.c#L2988">&lt;code>PyDict_Merge&lt;/code>&lt;/a> needs to use the slower method, which inserts entries one-by-one.&lt;/li>
&lt;/ul>
&lt;p>Whereas doing &lt;code>{}&lt;/code> causes Python to:&lt;/p>
&lt;ul>
&lt;li>construct a new &lt;strong>pre-allocated&lt;/strong> dictionary,&lt;/li>
&lt;li>insert entries one-by-one.&lt;/li>
&lt;/ul>
&lt;p>To be fair, unless you construct dictionaries in a loop, I don&amp;rsquo;t believe there&amp;rsquo;s a lot to gain performance-wise by
switching from &lt;code>dict&lt;/code> to &lt;code>{}&lt;/code>. There&amp;rsquo;s one thing I&amp;rsquo;d like you to remember after reading this post:&lt;/p>
&lt;div class="alert alert-info text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0 0 13.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 0 1-.75.75H9a.75.75 0 0 1-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 0 1-2.25 2.25H6.75A2.25 2.25 0 0 1 4.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 0 1 1.927-.184" />
&lt;/svg>&lt;/span>tl;dr&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">The &lt;code>{}&lt;/code> is always faster than &lt;code>dict&lt;/code>.&lt;/div>
&lt;/div>
&lt;/div>
&lt;h2 id="appendix" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#appendix" aria-label="Anchor">Appendix&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h2>
&lt;p>Similar analysis can be done for lists, sets, and (&lt;em>possibly&lt;/em>) tuples. However, this post is already too long, so I&amp;rsquo;ll
drop all the other resources I&amp;rsquo;ve gathered here.&lt;/p>
&lt;h3 id="lists" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#lists" aria-label="Anchor">Lists&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="ln" id="hl-13-1">&lt;a class="lnlinks" href="#hl-13-1">1&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;list((1, 2, &amp;#39;a&amp;#39;))&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-13-2">&lt;a class="lnlinks" href="#hl-13-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">5000000&lt;/span> loops, best of 5: 53.4 nsec per loop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-13-3">&lt;a class="lnlinks" href="#hl-13-3">3&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;[1, 2, &amp;#39;a&amp;#39;]&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-13-4">&lt;a class="lnlinks" href="#hl-13-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">10000000&lt;/span> loops, best of 5: 29.7 nsec per loop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="list-type" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#list-type" aria-label="Anchor">&lt;code>list&lt;/code> type&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>The Python&amp;rsquo;s &lt;code>list&lt;/code> type is defined in the &lt;code>listobject.c&lt;/code> file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-14-1">&lt;a class="lnlinks" href="#hl-14-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyTypeObject&lt;/span> &lt;span class="n">PyList_Type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-2">&lt;a class="lnlinks" href="#hl-14-2">2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-3">&lt;a class="lnlinks" href="#hl-14-3">3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">initproc&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">list___init__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_init */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-4">&lt;a class="lnlinks" href="#hl-14-4">4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyType_GenericAlloc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_alloc */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-5">&lt;a class="lnlinks" href="#hl-14-5">5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyType_GenericNew&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_new */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-6">&lt;a class="lnlinks" href="#hl-14-6">6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-14-7">&lt;a class="lnlinks" href="#hl-14-7">7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>PyType_GenericNew&lt;/code> does nothing &amp;mdash; it ignores &lt;code>args&lt;/code> and &lt;code>kwargs&lt;/code>, and return an object allocated by
&lt;code>type-&amp;gt;typ_alloc&lt;/code>. Source: &lt;a href="https://github.com/python/cpython/blob/main/Objects/typeobject.c#L1768" class="hide-external">https://github.com/python/cpython/blob/main/Objects/typeobject.c#L1768&lt;/a>&lt;/p>
&lt;p>&lt;code>PyType_GenericAlloc&lt;/code> allocated a new object and (if it&amp;rsquo;s garbage-collectable) marks it as &amp;ldquo;to-be-collected&amp;rdquo;.&lt;/p>
&lt;p>&lt;code>list___init__&lt;/code> is a convenience wrapper around the &lt;code>list___init___impl&lt;/code> function, which does the actual initialization.
It does some basic pre-steps:&lt;/p>
&lt;ul>
&lt;li>fails if any &lt;code>kwarg&lt;/code> has been passed,&lt;/li>
&lt;li>fails if &lt;code>args&lt;/code> has more than 1 element,&lt;/li>
&lt;li>converts the first argument of &lt;code>args&lt;/code> to an iterable.&lt;/li>
&lt;/ul>
&lt;p>&lt;code>list___init___impl&lt;/code> clears the list (if not empty) and extends it by the provided iterable (by calling the
&lt;code>list_extend&lt;/code> function).&lt;/p>
&lt;div class="alert alert-warning text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-warning-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
&lt;/svg>&lt;/span>Question&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">&lt;p>I think the two:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nb">list&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">_tmp&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">list&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">_tmp&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">extend&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>are equivalent in every way (but the generated opcodes sequence) and are calling the same underlying C code.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h4 id="-literal-expression" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#-literal-expression" aria-label="Anchor">&lt;code>[]&lt;/code> literal expression&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>Opcode &lt;code>BUILD_LIST&lt;/code> uses the &lt;code>_PyList_FromArraySteal&lt;/code> function to construct a list object and return it.&lt;/p>
&lt;div class="alert alert-info text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-info-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
&lt;/svg>&lt;/span>Note&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">&lt;p>_PyList_FromArraySteal is used since 3.12. See &lt;a href="https://docs.python.org/3.12/whatsnew/changelog.html">3.12 changelog&lt;/a>
and &lt;a href="https://github.com/python/cpython/pull/100147">gh-100146&lt;/a>. Before 3.12, the opcode was repeatedly calling &lt;code>POP()&lt;/code>
to get items from the stack, and then inserting them into the list.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">--&lt;/span>&lt;span class="n">oparg&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">POP&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">PyList_SET_ITEM&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">oparg&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>See &lt;a href="https://github.com/python/cpython/pull/100147/files#diff-729a985b0cb8b431cb291f1edb561bbbfea22e3f8c262451cd83328a0936a342L1447-L1450">change in gh-100146 PR&lt;/a>.&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>The &lt;code>_PyList_FromArraySteal&lt;/code> helper creates an empty list (if there are no items), or preallocates the list before
inserting items to it.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-15-1">&lt;a class="lnlinks" href="#hl-15-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyObject&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">dst&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ob_item&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-15-2">&lt;a class="lnlinks" href="#hl-15-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">memcpy&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="k">sizeof&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sets" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#sets" aria-label="Anchor">Sets&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h3>
&lt;div class="alert alert-warning text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-warning-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
&lt;/svg>&lt;/span>Warning&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">AFAIK there&amp;rsquo;s no way to construct a new set with a literal expression, hence the following analysis is performed for
sets with two elements: &lt;code>1&lt;/code> and &lt;code>2&lt;/code>.&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="ln" id="hl-16-1">&lt;a class="lnlinks" href="#hl-16-1">1&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;set((1, 2))&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-16-2">&lt;a class="lnlinks" href="#hl-16-2">2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">5000000&lt;/span> loops, best of 5: 82.6 nsec per loop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-16-3">&lt;a class="lnlinks" href="#hl-16-3">3&lt;/a>&lt;/span>&lt;span class="cl">$ python -m timeit &lt;span class="s2">&amp;#34;{1, 2}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-16-4">&lt;a class="lnlinks" href="#hl-16-4">4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="m">5000000&lt;/span> loops, best of 5: 45.5 nsec per loop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="set-type" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#set-type" aria-label="Anchor">&lt;code>set&lt;/code> type&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>The Python&amp;rsquo;s &lt;code>set&lt;/code> type is defined in the &lt;code>setobject.c&lt;/code> file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-17-1">&lt;a class="lnlinks" href="#hl-17-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyTypeObject&lt;/span> &lt;span class="n">PySet_Type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-2">&lt;a class="lnlinks" href="#hl-17-2">2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-3">&lt;a class="lnlinks" href="#hl-17-3">3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">initproc&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">set_init&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_init */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-4">&lt;a class="lnlinks" href="#hl-17-4">4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyType_GenericAlloc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_alloc */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-5">&lt;a class="lnlinks" href="#hl-17-5">5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">set_new&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_new */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-6">&lt;a class="lnlinks" href="#hl-17-6">6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-17-7">&lt;a class="lnlinks" href="#hl-17-7">7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>set_new&lt;/code> uses the allocated to create a new empty set object. Internally it calls the &lt;code>make_new_set&lt;/code> function.&lt;/p>
&lt;p>&lt;code>set_init&lt;/code> performs some pre-steps:&lt;/p>
&lt;ul>
&lt;li>fails if any &lt;code>kwarg&lt;/code> has been passed,&lt;/li>
&lt;li>fails if &lt;code>args&lt;/code> has more then 1 element,&lt;/li>
&lt;li>converts the first argument of &lt;code>args&lt;/code> to an iterable,&lt;/li>
&lt;li>if the set object has already been filled, then it clears it&lt;/li>
&lt;/ul>
&lt;p>&amp;hellip; and calls the &lt;code>set_update_internal&lt;/code> function, to insert values into the set object.&lt;/p>
&lt;h4 id="1-2-literal-expression" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#1-2-literal-expression" aria-label="Anchor">&lt;code>{1, 2}&lt;/code> literal expression&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>The opcode handler has no dedicated helpers. It constructs a new set (empty), and then iterates over all items from the
stack and insets them one-by-one.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-18-1">&lt;a class="lnlinks" href="#hl-18-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="nf">inst&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">BUILD_SET&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">values&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">oparg&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">set&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-2">&lt;a class="lnlinks" href="#hl-18-2"> 2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">set&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">PySet_New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-3">&lt;a class="lnlinks" href="#hl-18-3"> 3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">set&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-4">&lt;a class="lnlinks" href="#hl-18-4"> 4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">GOTO_ERROR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">error&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-5">&lt;a class="lnlinks" href="#hl-18-5"> 5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-6">&lt;a class="lnlinks" href="#hl-18-6"> 6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">oparg&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-7">&lt;a class="lnlinks" href="#hl-18-7"> 7&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">PyObject&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">item&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">values&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-8">&lt;a class="lnlinks" href="#hl-18-8"> 8&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">err&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-9">&lt;a class="lnlinks" href="#hl-18-9"> 9&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">err&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nf">PySet_Add&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-10">&lt;a class="lnlinks" href="#hl-18-10">10&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">Py_DECREF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-11">&lt;a class="lnlinks" href="#hl-18-11">11&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-12">&lt;a class="lnlinks" href="#hl-18-12">12&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-13">&lt;a class="lnlinks" href="#hl-18-13">13&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">Py_DECREF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">set&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-14">&lt;a class="lnlinks" href="#hl-18-14">14&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="nf">ERROR_IF&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">error&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-15">&lt;a class="lnlinks" href="#hl-18-15">15&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-18-16">&lt;a class="lnlinks" href="#hl-18-16">16&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Source: &lt;a href="https://github.com/python/cpython/blob/main/Python/bytecodes.c#L1627" class="hide-external">https://github.com/python/cpython/blob/main/Python/bytecodes.c#L1627&lt;/a>.&lt;/p>
&lt;div class="alert alert-warning text-left text-text flex flex-col items-start gap-0" >
&lt;h6 class="text-warning-content flex gap-1 items-center !my-0 !text-lg">&lt;span class="">&lt;svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
&lt;path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
&lt;/svg>&lt;/span>Warning&lt;/h6>
&lt;div class="collapsible-content w-full">
&lt;div class="mt-2 w-full text-base-content markdown-body">&lt;p>Warning
The generated bytecode is different if we add another argument to the literal expression: &lt;code>{1, 2, 3}&lt;/code>. Then it becomes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-0-1">&lt;a class="lnlinks" href="#hl-0-1">1&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">2&lt;/span> &lt;span class="n">BUILD_SET&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-2">&lt;a class="lnlinks" href="#hl-0-2">2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">4&lt;/span> &lt;span class="n">LOAD_CONST&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">frozenset&lt;/span>&lt;span class="p">({&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">}))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-3">&lt;a class="lnlinks" href="#hl-0-3">3&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">6&lt;/span> &lt;span class="n">SET_UPDATE&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-0-4">&lt;a class="lnlinks" href="#hl-0-4">4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">8&lt;/span> &lt;span class="n">RETURN_VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/div>
&lt;/div>
&lt;/div>
&lt;h3 id="tuples" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#tuples" aria-label="Anchor">Tuples&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h3>
&lt;p>This one&amp;rsquo;s tricky. Constructing a tuple with the &lt;code>tuple&lt;/code> type requires an iterable. The easiest way of getting one it to
create a tuple literal, which is obviously less efficient, than using a tuple literal syntax in the first place.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln" id="hl-19-1">&lt;a class="lnlinks" href="#hl-19-1"> 1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-2">&lt;a class="lnlinks" href="#hl-19-2"> 2&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">version_info&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-3">&lt;a class="lnlinks" href="#hl-19-3"> 3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">version_info&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">major&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">minor&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">micro&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">releaselevel&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;final&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">serial&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-4">&lt;a class="lnlinks" href="#hl-19-4"> 4&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-5">&lt;a class="lnlinks" href="#hl-19-5"> 5&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">a&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-6">&lt;a class="lnlinks" href="#hl-19-6"> 6&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="nb">tuple&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[]))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-7">&lt;a class="lnlinks" href="#hl-19-7"> 7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-8">&lt;a class="lnlinks" href="#hl-19-8"> 8&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">b&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-9">&lt;a class="lnlinks" href="#hl-19-9"> 9&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="p">[])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-10">&lt;a class="lnlinks" href="#hl-19-10">10&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-11">&lt;a class="lnlinks" href="#hl-19-11">11&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="nn">dis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-12">&lt;a class="lnlinks" href="#hl-19-12">12&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-13">&lt;a class="lnlinks" href="#hl-19-13">13&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-14">&lt;a class="lnlinks" href="#hl-19-14">14&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">1&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="n">RESUME&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-15">&lt;a class="lnlinks" href="#hl-19-15">15&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-16">&lt;a class="lnlinks" href="#hl-19-16">16&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">2&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">LOAD_GLOBAL&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">NULL&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nb">tuple&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-17">&lt;a class="lnlinks" href="#hl-19-17">17&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">12&lt;/span> &lt;span class="n">LOAD_CONST&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-18">&lt;a class="lnlinks" href="#hl-19-18">18&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">14&lt;/span> &lt;span class="n">LOAD_CONST&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-19">&lt;a class="lnlinks" href="#hl-19-19">19&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">16&lt;/span> &lt;span class="n">BUILD_LIST&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-20">&lt;a class="lnlinks" href="#hl-19-20">20&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">18&lt;/span> &lt;span class="n">BUILD_TUPLE&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-21">&lt;a class="lnlinks" href="#hl-19-21">21&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">20&lt;/span> &lt;span class="n">CALL&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-22">&lt;a class="lnlinks" href="#hl-19-22">22&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">28&lt;/span> &lt;span class="n">RETURN_VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-23">&lt;a class="lnlinks" href="#hl-19-23">23&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dis&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dis&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-24">&lt;a class="lnlinks" href="#hl-19-24">24&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">1&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="n">RESUME&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-25">&lt;a class="lnlinks" href="#hl-19-25">25&lt;/a>&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-26">&lt;a class="lnlinks" href="#hl-19-26">26&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">2&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="n">LOAD_CONST&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-27">&lt;a class="lnlinks" href="#hl-19-27">27&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">4&lt;/span> &lt;span class="n">LOAD_CONST&lt;/span> &lt;span class="mi">2&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-28">&lt;a class="lnlinks" href="#hl-19-28">28&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">6&lt;/span> &lt;span class="n">BUILD_LIST&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-29">&lt;a class="lnlinks" href="#hl-19-29">29&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">8&lt;/span> &lt;span class="n">BUILD_TUPLE&lt;/span> &lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-19-30">&lt;a class="lnlinks" href="#hl-19-30">30&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">10&lt;/span> &lt;span class="n">RETURN_VALUE&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It might not make much sense to include this example in the article.&lt;/p>
&lt;h4 id="tuple-type" class="my-8 md:my-12 flex items-center justify-center">
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;a class="font-bold text-center w-full md:w-fit mx-4 !no-underline !link-neutral"
href="#tuple-type" aria-label="Anchor">&lt;code>tuple&lt;/code> type&lt;/a>
&lt;hr class="w-1/12 border-neutral shrink-0 hidden md:block" />
&lt;/h4>
&lt;p>The Python&amp;rsquo;s &lt;code>tuple&lt;/code> type is defined in &lt;code>tupleobject.c&lt;/code>. Interestingly, it has no &lt;code>tp_alloc&lt;/code>, nor &lt;code>tp_init&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln" id="hl-20-1">&lt;a class="lnlinks" href="#hl-20-1">1&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="n">PyTypeObject&lt;/span> &lt;span class="n">PyTuple_Type&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-2">&lt;a class="lnlinks" href="#hl-20-2">2&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-3">&lt;a class="lnlinks" href="#hl-20-3">3&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_init */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-4">&lt;a class="lnlinks" href="#hl-20-4">4&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_alloc */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-5">&lt;a class="lnlinks" href="#hl-20-5">5&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="n">tuple_new&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="cm">/* tp_new */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-6">&lt;a class="lnlinks" href="#hl-20-6">6&lt;/a>&lt;/span>&lt;span class="cl"> &lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln" id="hl-20-7">&lt;a class="lnlinks" href="#hl-20-7">7&lt;/a>&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>tuple_new&lt;/code> function is responsible for allocating a new tuple object, with the items passed as a parameter.&lt;/p></description></item></channel></rss>